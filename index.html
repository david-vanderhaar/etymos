<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Etymos</title>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light-border.css"/>
  <link rel="stylesheet" href="main.css">
</head>

<body>
  <h1>Etym<span class="highlight-text">o</span>s</h1>
  <div class="box" id="editor" contenteditable="true"></div>
</body>
<script>
  const editor = document.getElementById("editor");
  editor.addEventListener("input", onEditorInput);
  editor.focus();

  function onEditorInput(event) {
    const text = editor.innerHTML;
    const [highlightedText, cleanText] = highlightProperNouns(text);
    setEditorContent(highlightedText);
    createTooltips();
    resetCursorPositionToEnd()
  }

  function highlightProperNouns(text) {
    const cleanText = text.replace(/<[^>]*>/g, "");
    const properNounRegex = /\b[A-Z][a-z]*\b/g;
    const matches = cleanText.match(properNounRegex);
    if (!matches) return [cleanText, cleanText];
    let id = 0;
    const highlightedText = cleanText.replace(
      properNounRegex,
      (match) => {
        id++;
        return `<span class="proper-noun tooltip" id="${id}">${match}</span>`;
    });

    return [highlightedText, cleanText];
  }

  function setEditorContent(content) {
    editor.innerHTML = content;
  }

  function createTooltips() {
    // using tippy.js
    const properNouns = editor.querySelectorAll(".proper-noun");
    properNouns.forEach(properNoun => {
      const id = properNoun.id;
      const content = suggetionListElement(id, suggestReplacements(properNoun.innerHTML))
      if (content) {
        properNoun.classList.add("animate-highlight");
        const tooltip = tippy(properNoun, {
          content: content,
          allowHTML: true,
          interactive: true,
          placement: "bottom",
          maxWidth: "none",
          theme: "light-border",
        });
      }
    });
  }

  function resetCursorPositionToEnd() {
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(editor);
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
  }

  function suggetionListElement(id, suggestion) {
    if (!suggestion) return "";

    const word = suggestion.word;
    const iframe = createEtymologyOnlineIframe(word);
    if (!suggestion.replacements.length) {
      return `<div class="suggestion" data-suggestion="${word}" data-id="${id}">
          ${word}
          ${iframe.outerHTML}
        </div>`;
    } else {
      const replacements = suggestion.replacements;
      return `<div class="suggestion" data-suggestion="${word}" data-id="${id}">
          ${word}: ${replacementElements(word, replacements)}
          ${iframe.outerHTML}
        </div>`;
    }
  }

  function replacementElements(word, replacements) {
    return replacements
      .map((replacement) => replacementElement(word, replacement))
      .join(", ");
  }

  function replacementElement(word, replacement) {
    const onclick = `onSuggestionClick(event, '${word}', '${replacement}')`;
    return `<span class="replacement" onclick="${onclick}">${replacement}</span>`;
  }

  function onSuggestionClick(event, properNoun, replacementString) {
    const id = event.target.parentElement.dataset.id;
    const properNounElement = document.getElementById(id);
    properNounElement.outerHTML = replacementString;
    resetCursorPositionToEnd();
  }


  function createEtymologyOnlineIframe(word) {
    // https://www.etymonline.com/search?q=golgotha
    const iframe = document.createElement("iframe");
    iframe.src = `https://www.etymonline.com/search?q=${word}`;
    iframe.width = "100%";
    iframe.height = "400px";
    iframe.style.border = "none";
    return iframe;
  }

  function suggestReplacements(properNoun) {
    if (!properNoun) return null;
    if (properNoun.length < 3) return null;

    // You can use an API here to fetch suggestions based on the proper noun.
    // For simplicity, I'll provide a local example.
    const replacements = {
      "David": {
        word: properNoun,
        replacements: ["The beloved", "King of Israel", "Beloved one"]
      }
    };
    return replacements[properNoun] || { word: properNoun, replacements: []}
    // return replacements[properNoun] || null
  }

  // helpers
  function debounce(func, wait, immediate) {
    let timeout;

    return function executedFunction() {
      const context = this;
      const args = arguments;

      const later = function () {
        timeout = null;
        if (!immediate) func.apply(context, args);
      };

      const callNow = immediate && !timeout;
      clearTimeout(timeout);

      timeout = setTimeout(later, wait);

      if (callNow) func.apply(context, args);
    };
  }
</script>
</html>